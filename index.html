<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel File Viewer and Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.16.2/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.css">
    <script src="https://cdn.jsdelivr.net/npm/handsontable@11.1.0/dist/handsontable.full.min.js"></script>
    <style>
        .sheet {
            margin-bottom: 20px;
            border: 1px solid #000;
            padding: 10px;
        }
        .handsontable {
            width: 100%;
        }
        button {
            margin-top: 20px;
        }
    </style>
</head>
<body>

<h2>Excel File Viewer and Editor</h2>
<div id="sheetsContainer"></div>

<button id="saveBtn">Save Changes to GitHub</button>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const excelFileUrl = 'https://raw.githubusercontent.com/ARPROGAM/Davomatt/89f4349f596c0136125544ee9937538b278c5609/BIQ%20213-21%20guruh%20davomat.xlsx';

        // Fetch the Excel file from GitHub
        fetch(excelFileUrl)
        .then(response => response.arrayBuffer())
        .then(data => {
            const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
            const sheetsContainer = document.getElementById('sheetsContainer');

            // Loop through each sheet in the workbook and display them as Handsontable
            workbook.SheetNames.forEach(function(sheetName) {
                const sheet = workbook.Sheets[sheetName];
                const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                // Create a div for each sheet
                const sheetDiv = document.createElement('div');
                sheetDiv.classList.add('sheet');
                sheetDiv.innerHTML = `<h3>${sheetName}</h3>`;
                const tableDiv = document.createElement('div');
                sheetDiv.appendChild(tableDiv);
                sheetsContainer.appendChild(sheetDiv);

                // Initialize Handsontable
                const hot = new Handsontable(tableDiv, {
                    data: sheetData,
                    rowHeaders: true,
                    colHeaders: true,
                    contextMenu: true,
                    licenseKey: 'non-commercial-and-evaluation'
                });

                // Save the Handsontable instance for each sheet
                sheetDiv.handsontable = hot;
            });
        })
        .catch(error => console.error('Error fetching the Excel file:', error));

        // Save Changes Button Click Event
        document.getElementById('saveBtn').addEventListener('click', function() {
            const updatedData = [];

            // Collect updated data from each Handsontable instance
            const sheets = document.getElementById('sheetsContainer').children;
            Array.from(sheets).forEach(sheetDiv => {
                const hot = sheetDiv.handsontable;
                if (hot) {
                    const data = hot.getData();
                    updatedData.push(data);  // Push sheet data
                }
            });

            // Send updated data to the backend (to save and push to GitHub)
            fetch('/save-to-github', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updatedData })
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Changes saved to GitHub successfully!');
                } else {
                    alert('Failed to save changes to GitHub.');
                }
            });
        });
    });
</script>

</body>
</html>
